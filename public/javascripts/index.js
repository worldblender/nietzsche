var target,targetListener,missileButton,shieldButton,landmineButton,worldMap,worldTopbar,allPlayers,allMissiles,serverTimeDiff,tick,uid,reconnectBox,eventPane,yourLocation,attackButton,actionButtons,actionToggle,respawnButton,defenseButton,defenseButtons,shieldToggle;var socket=new io.Socket("n.worldblender.com");TICK_INTERVAL=700;BLAST_SPEED=20;RAD_TO_METERS=6371*1000;MISSILE_RADIUS=400;MISSILE_DAMAGE=40;MISSILE_VELOCITY=50;MISSILE_ACCELERATION=0.0868;Ext.gesture.Manager.onMouseEventOld=Ext.gesture.Manager.onMouseEvent;Ext.gesture.Manager.onMouseEvent=function(b){var a=b.target;while(a){if(Ext.fly(a)&&Ext.fly(a).hasCls("x-map")){return}a=a.parentNode}this.onMouseEventOld.apply(this,arguments)};MI_Crosshairs=new google.maps.MarkerImage("images/crosshairs.png",new google.maps.Size(40,40),new google.maps.Point(0,0),new google.maps.Point(23,23));MI_Soldier=new google.maps.MarkerImage("images/alive.png",new google.maps.Size(24,24),new google.maps.Point(0,0),new google.maps.Point(12,12));MI_Dead=new google.maps.MarkerImage("images/dead.png",new google.maps.Size(24,24),new google.maps.Point(0,0),new google.maps.Point(12,12),new google.maps.Size(24,24));function haversineDistance(b,j){var f=(j.lat-b.lat)*Math.PI/180;var g=(j.lng-b.lng)*Math.PI/180;var e=Math.sin(f/2)*Math.sin(f/2)+Math.cos(b.lat*Math.PI/180)*Math.cos(j.lat*Math.PI/180)*Math.sin(g/2)*Math.sin(g/2);var i=2*Math.atan2(Math.sqrt(e),Math.sqrt(1-e));var h=RAD_TO_METERS*i;return h}function getRank(a){if(a<100){return"Trainee"}else{if(a<300){return"Rookie"}else{if(a<1000){return"Agent"}else{return"Pro"}}}}function calcXP(a){if(!a.aliveSince){return a.gxp}return Math.floor((serverTimeDiff+(new Date()).getTime()-a.aliveSince)/60000)+a.gxp}function numReadyMissiles(a){var c=0;for(var b=0;b<a.length;++b){if(a[b]===null){c++}}return c}function connectLoop(){if(socket.connected){reconnectBox.hide()}else{setTimeout(connectLoop,2000);socket.connect()}}function killed(){actionToggle(null,null,false);actionButtons.setPressed(attackButton,false);actionButtons.setPressed(defenseButton,false);attackButton.disable(true);defenseButton.disable(true);worldTopbar.setTitle("<font size=-1>You died</font>");respawnButton.show()}function alive(){socket.send({e:"respawn",uid:uid})}function drawPlayer(d,c){var a=new google.maps.LatLng(allPlayers[d].coords.lat,allPlayers[d].coords.lng);var b=null;if(c){b=google.maps.Animation.DROP}if(allPlayers[d].marker){allPlayers[d].marker.setMap(null)}if(allPlayers[d].hp>0){allPlayers[d].marker=new google.maps.Marker({position:a,map:worldMap.map,animation:b,clickable:actionButtons.getPressed()!==attackButton,icon:MI_Soldier});if(d===uid){allPlayers[d].marker.setAnimation(google.maps.Animation.BOUNCE)}}else{allPlayers[d].marker=new google.maps.Marker({position:a,map:worldMap.map,clickable:actionButtons.getPressed()!==attackButton,icon:MI_Dead})}allPlayers[d].marker.info=allPlayers[d];google.maps.event.addListener(allPlayers[d].marker,"click",function(){if(this.info.hp>0){Ext.Msg.alert(this.info.name,this.info.hp+"hp "+calcXP(this.info)+"xp")}else{Ext.Msg.alert(this.info.name,this.info.name+"'s remains lay here")}})}function drawMissile(b){var a=((serverTimeDiff+(new Date()).getTime()-allMissiles[b].departureTime)/(allMissiles[b].arrivalTime-allMissiles[b].departureTime));if(a>1||a<0){return}var d=[new google.maps.LatLng(allMissiles[b].departureCoords.lat,allMissiles[b].departureCoords.lng),new google.maps.LatLng(allMissiles[b].departureCoords.lat+(allMissiles[b].arrivalCoords.lat-allMissiles[b].departureCoords.lat)*a,allMissiles[b].departureCoords.lng+(allMissiles[b].arrivalCoords.lng-allMissiles[b].departureCoords.lng)*a)];if(allMissiles[b].line){allMissiles[b].line.setPath(d)}else{var c=new google.maps.Polyline({path:d,strokeColor:"#00FFFF",strokeOpacity:1,strokeWeight:2,clickable:false});c.setMap(worldMap.map);allMissiles[b].line=c}}function populateMap(){for(var a in allPlayers){drawPlayer(a)}navigator.geolocation.watchPosition(function(b){if(yourLocation.lat===b.coords.latitude&&yourLocation.lng===b.coords.longitude){return}yourLocation={lat:b.coords.latitude,lng:b.coords.longitude};if(allPlayers[uid].hp>0){allPlayers[uid].coords.lat=b.coords.latitude;allPlayers[uid].coords.lng=b.coords.longitude;socket.send({e:"move",uid:uid,loc:allPlayers[uid].coords});allPlayers[uid].marker.setPosition(new google.maps.LatLng(b.coords.latitude,b.coords.longitude))}})}shieldToggle=function(b,a,c){if(this.shieldTimer){clearInterval(this.shieldTimer)}if(c){if(a!=="sync"){socket.send({e:"shield",uid:uid,active:1});allPlayers[uid].items.s.a=1}this.shieldTimer=setInterval(function(){if(allPlayers[uid].items.s.e>0){allPlayers[uid].items.s.e--;shieldButton.setBadge(allPlayers[uid].items.s.e)}if(allPlayers[uid].items.s.e===0){clearInterval(this.shieldTimer);this.shieldTimer=null}},1000)}else{if(a!=="sync"){socket.send({e:"shield",uid:uid,active:0});allPlayers[uid].items.s.a=0}this.shieldTimer=setInterval(function(){if(allPlayers[uid].items.s.e<100){allPlayers[uid].items.s.e++;shieldButton.setBadge(allPlayers[uid].items.s.e)}if(allPlayers[uid].items.s.e===100){clearInterval(this.shieldTimer);this.shieldTimer=null}},1000)}};uid=localStorage.uid;if(!uid){uid=Math.random().toString().substring(2);localStorage.uid=uid}socket.on("message",function(h){console.log(h);if(h.e==="sync"){serverTimeDiff=h.time-(new Date()).getTime();if(allPlayers){for(var a in allPlayers){if(allPlayers[a].marker){allPlayers[a].marker.setMap(null)}}}allPlayers=h.players;if(allMissiles){for(var c=0;c<allMissiles.length;++c){if(allMissiles[c]&&allMissiles[c].line){allMissiles[c].line.setMap(null)}}}shieldToggle(null,"sync",allPlayers[uid].items.s.a===1);allMissiles=h.missiles;if(allPlayers[uid].hp<=0&&worldTopbar){killed()}allPlayers[uid].readyMissiles=numReadyMissiles(allPlayers[uid].items.m.m);missileButton.setBadge(allPlayers[uid].readyMissiles);if(allPlayers[uid].readyMissiles===0){missileButton.disable(true)}shieldButton.setBadge(allPlayers[uid].items.s.e);populateMap();setInterval(tick,TICK_INTERVAL)}else{if(h.e==="player"){allPlayers[h.player._id]=h.player;drawPlayer(h.player._id,true)}else{if(h.e==="missile"){allMissiles.push(h.missile)}else{if(h.e==="moved"){var n=new google.maps.LatLng(h.loc.lat,h.loc.lng);allPlayers[h.player].coords=n;if(allPlayers[h.player].marker){allPlayers[h.player].marker.setPosition(n)}}else{if(h.e==="damage"){for(var l=0;l<h.damage.length;++l){allPlayers[h.damage[l].player].hp-=h.damage[l].dmg;if(allPlayers[h.damage[l].player].hp<=0&&h.damage[l].dmg>0){allPlayers[h.damage[l].player].hp=0;allPlayers[h.damage[l].player].marker.setMap(null);allPlayers[h.damage[l].player].aliveSince=null;drawPlayer(h.damage[l].player);if(h.damage[l].player===uid&&worldTopbar){killed();Ext.Msg.alert("Dead!",allPlayers[uid].name+", you have been killed!")}}if(h.damage[l].player===uid){allPlayers[uid].items.s.e-=h.damage[l].sDmg;shieldButton.setBadge(allPlayers[uid].items.s.e)}}}else{if(h.e==="gxp"){allPlayers[h.uid].gxp+=h.gxp}else{if(h.e==="events"){var s="<b>Recent events</b>";for(var f=0;f<h.events.length;f++){var o=h.events[f];var r=new Date(parseInt(o._id.substring(0,8),16)*1000);s+="<br><font color='grey'>"+r.getMonth()+1+"/"+r.getDate()+" "+r.getHours()+":"+(r.getMinutes()<10?"0":"")+r.getMinutes()+":"+(r.getSeconds()<10?"0":"")+r.getSeconds()+"</font> ";if(o.e==="missile"){s+="Launched missile <img src='images/missile.png'>"}else{if(o.e==="kill"){s+="Killed "+allPlayers[o.data].name+" <img src='images/stamina.png'>"}else{if(o.e==="killed"){s+="Killed by "+allPlayers[o.data].name+" <img width='16' height='16' src='images/dead.png'>"}else{if(o.e==="damage"){s+="You hit";for(var g=0;g<o.data.length;g++){var q=o.data[g];s+=" "+allPlayers[q.player].name+" ("+q.dmg+" <img src='images/damage.png'>)"}}else{if(o.e==="damaged"){s+="Hit by missile (-"+o.data.dmg+" <img src='images/health.png'>, -"+o.data.sDmg+"<img src='images/shield.png'>)"}else{if(o.e==="respawn"){s+="Respawned <img src='images/respawn.png'>"}else{if(o.e==="shield"){if(o.active===1){s+="Activated shields"}else{s+="Deactivated shields"}}}}}}}}}eventPane.update('<font color="9afe2e">'+s+"</font>")}else{if(h.e==="respawn"){if(uid===h.player._id){respawnButton.hide();attackButton.enable(true);defenseButton.enable(true);worldTopbar.setTitle("");allPlayers[uid].readyMissiles=numReadyMissiles(allPlayers[uid].items.m.m);missileButton.setBadge(allPlayers[uid].readyMissiles);if(allPlayers[uid].readyMissiles===0){missileButton.disable(true)}shieldButton.setBadge(allPlayers[uid].items.s.e)}if(allPlayers[h.player._id].marker){allPlayers[h.player._id].marker.setMap(null)}allPlayers[h.player._id]=h.player;drawPlayer(h.player._id,true)}else{if(h.e==="say"){var b=new google.maps.InfoWindow({content:h.msg,disableAutoPan:true});b.open(worldMap.map,allPlayers[h.uid].marker);setTimeout(function(){b.close()},10000)}}}}}}}}}});socket.on("connect",function(){if(yourLocation){socket.send({e:"init",uid:uid,loc:yourLocation})}});socket.on("disconnect",function(){reconnectBox=Ext.Msg.show({title:"Disconnected",msg:"Attempting to automatically reconnect...",buttons:[]});setTimeout(connectLoop,2000)});Ext.setup({icon:"images/icon.png",tabletStartupScreen:"images/tablet_startup.png",phoneStartupScreen:"images/phone_startup.png",glossOnIcon:true,onReady:function(){Ext.Msg.enterAnimation=false;Ext.Msg.exitAnimation=false;var a=function(h,i){socket.send({e:"m",uid:uid,loc:{lat:target.getPosition().lat(),lng:target.getPosition().lng()}});allPlayers[uid].readyMissiles--;missileButton.setBadge(allPlayers[uid].readyMissiles);if(allPlayers[uid].readyMissiles===0){missileButton.disable(true)}};actionToggle=function(i,h,j){if(h===attackButton&&j){worldTopbar.setTitle("<font size=-1>Tap target</font>");for(var k in allPlayers){if(allPlayers[k].marker){allPlayers[k].marker.setClickable(false)}}targetListener=google.maps.event.addListener(worldMap.map,"click",function(l){if(target){target.setMap(null)}target=new google.maps.Marker({position:l.latLng,map:worldMap.map,clickable:false,zIndex:9999,icon:MI_Crosshairs});missileButton.show();var n=haversineDistance({lat:target.getPosition().lat(),lng:target.getPosition().lng()},allPlayers[uid].coords);var m=(-MISSILE_VELOCITY+Math.sqrt(MISSILE_VELOCITY*MISSILE_VELOCITY+2*MISSILE_ACCELERATION*n))/MISSILE_ACCELERATION;worldTopbar.setTitle("<font size=-1>"+Math.round(n)+"m ("+Math.round(m)+"s)</font>")})}else{missileButton.hide();worldTopbar.setTitle("");if(target){target.setMap(null)}if(targetListener){google.maps.event.removeListener(targetListener);targetListener=null}for(k in allPlayers){if(allPlayers[k].marker){allPlayers[k].marker.setClickable(true)}}}if(h===defenseButton&&j){defenseButtons.show();defenseButtons.setPressed(shieldButton,allPlayers[uid].items.s.a===1,true)}else{defenseButtons.hide()}};missileButton=new Ext.Button({text:"Missile",ui:"action",hidden:true,handler:a});missileButton.setWidth(84);shieldButton=new Ext.Button({text:"Shield",ui:"action",});shieldButton.setWidth(94);defenseButtons=new Ext.SegmentedButton({allowDepress:true,listeners:{toggle:shieldToggle},items:[shieldButton],hidden:true});defenseButtons.setWidth(94);respawnButton=new Ext.Button({text:"Respawn",hidden:true,handler:alive,ui:"confirm"});attackButton=new Ext.Button({cls:"attackButton",ui:"action"});defenseButton=new Ext.Button({cls:"defenseButton",ui:"action"});actionButtons=new Ext.SegmentedButton({allowDepress:true,listeners:{toggle:actionToggle},items:[attackButton,defenseButton]});var f=new Ext.Button({text:"Say",ui:"action",handler:function(){Ext.Msg.prompt("Say what?",null,function(h,i){if(h==="ok"){socket.send({e:"say",uid:uid,msg:i})}})}});worldTopbar=new Ext.Toolbar({dock:"top",title:"<font size=-1>GPS Missiles</font>",items:[actionButtons,f,{xtype:"spacer"},missileButton,defenseButtons,respawnButton]});if(allPlayers&&allPlayers[uid].hp<=0){killed()}var c;if(yourLocation){c=new google.maps.LatLng(yourLocation.lat,yourLocation.lng)}else{c=new google.maps.LatLng(47.6063889,-122.3308333)}worldMap=new Ext.Map({mapOptions:{center:c,zoom:13,mapTypeId:"customMap",mapTypeControl:false,streetViewControl:false,zoomControl:true},listeners:{maprender:function(h,i){i.mapTypes.set("customMap",new google.maps.StyledMapType(MapStyles.tron,{name:"Custom Style"}));socket.connect()}}});var d=new Ext.Panel({iconCls:"search",title:"World",items:[worldMap],dockedItems:[worldTopbar]});var e=new Ext.form.Text({name:"username",label:"Name"});var g=new Ext.Container();eventPane=new Ext.Container({html:"<b>Recent events</b>",style:{fontSize:"75%"}});var b=new Ext.Panel({title:"Profile",iconCls:"user",listeners:{activate:function(){e.setValue(allPlayers[uid].name);var i=calcXP(allPlayers[uid]);var h="<table><tr><td><img src='images/health.png'> "+allPlayers[uid].hp+" / 100<br></td><td><img src='images/missile.png'> "+allPlayers[uid].readyMissiles+" missiles ready<br></td></tr><tr><td><img src='images/xp.png'> "+i+"xp <font size='-1'><b>"+getRank(i)+"</b></font><br></td><td><img src='images/damage.png'> "+allPlayers[uid].items.m.d+" max damage<br></td></tr><tr><td><img src='images/attack.png'> "+allPlayers[uid].gxp/100+" kills<br></td><td><img src='images/blast.png'> "+allPlayers[uid].items.m.r+" blast radius</td></tr></table>";g.update('<font color="9afe2e">'+h+"</font>");socket.send({e:"events",uid:uid})}},items:[{xtype:"form",scroll:"vertical",baseCls:"background",items:[e,{xtype:"spacer",height:5},{xtype:"button",text:"Save Name",ui:"confirm",width:140,handler:function(){var h=e.getValue();if(h){allPlayers[uid].name=h;socket.send({e:"name",uid:uid,name:h});this.setText("Saved");this.disable(true)}}},{xtype:"spacer",height:15},g,{xtype:"spacer",height:14},eventPane]}]});new Ext.TabPanel({fullscreen:true,cardSwitchAnimation:false,style:{backgroundColor:"black"},tabBar:{dock:"bottom",layout:{pack:"center"}},items:[d,b]});if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(h){yourLocation={lat:h.coords.latitude,lng:h.coords.longitude};if(allPlayers&&allPlayers[uid].hp>0){allPlayers[uid].coords=yourLocation}if(h.coords.accuracy>500){Ext.Msg.alert("Geolocation Approximation","You location is currently only accurate within "+Math.round(h.coords.accuracy)+" meters.")}worldMap.map.setCenter(new google.maps.LatLng(h.coords.latitude,h.coords.longitude));if(socket.connected){socket.send({e:"init",uid:uid,loc:yourLocation})}},function(h){Ext.Msg.alert("Geolocation error",h.message)},{enableHighAccuracy:true,timeout:20000})}else{Ext.Msg.alert("No Geolocation","Your browser does not support geolocation. Please try a different browser.")}}});tick=function(){for(var a=0;a<allMissiles.length;++a){if(!allMissiles[a]){continue}if(serverTimeDiff+(new Date()).getTime()>allMissiles[a].arrivalTime){if(allMissiles[a].blastR){if(allMissiles[a].blastR>=MISSILE_RADIUS&&allMissiles[a].blastR%2===0){allMissiles[a].blastR--}else{if(allMissiles[a].blastR%2===0){allMissiles[a].blastR+=BLAST_SPEED}else{if(allMissiles[a].blastR<BLAST_SPEED){allMissiles[a].c.setMap(null);allMissiles[a]=null;continue}else{allMissiles[a].blastR-=BLAST_SPEED}}}allMissiles[a].c.setRadius(allMissiles[a].blastR)}else{allMissiles[a].blastR=BLAST_SPEED;if(allMissiles[a].line){allMissiles[a].line.setMap(null);allMissiles[a].line=null}if(allMissiles[a].owner===uid){allPlayers[uid].readyMissiles++;missileButton.setBadge(allPlayers[uid].readyMissiles);missileButton.enable(true)}allMissiles[a].c=new google.maps.Circle({center:new google.maps.LatLng(allMissiles[a].arrivalCoords.lat,allMissiles[a].arrivalCoords.lng),fillColor:"#00FFFF",fillOpacity:0.5,strokeColor:"#00FFFF",map:worldMap.map,clickable:false,radius:BLAST_SPEED})}}else{drawMissile(a)}}};