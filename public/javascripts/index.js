var target,targetListener,missileButton,shieldButton,landmineButton,worldMap,worldTopbar,allPlayers,allMissiles,serverTimeDiff,tick,uid,reconnectBox,eventPane,yourLocation,attackButton,actionButtons,actionToggle,respawnButton,defenseButton,defenseButtons,shieldToggle,socket=new io.Socket("n.worldblender.com");TICK_INTERVAL=700;BLAST_SPEED=20;RAD_TO_METERS=6371E3;MISSILE_RADIUS=400;MISSILE_DAMAGE=40;MISSILE_VELOCITY=50;MISSILE_ACCELERATION=0.0868;Ext.gesture.Manager.onMouseEventOld=Ext.gesture.Manager.onMouseEvent;
Ext.gesture.Manager.onMouseEvent=function(a){for(var b=a.target;b;){if(Ext.fly(b)&&Ext.fly(b).hasCls("x-map"))return;b=b.parentNode}this.onMouseEventOld.apply(this,arguments)};MI_Crosshairs=new google.maps.MarkerImage("images/crosshairs.png",new google.maps.Size(40,40),new google.maps.Point(0,0),new google.maps.Point(23,23));MI_Soldier=new google.maps.MarkerImage("images/alive.png",new google.maps.Size(24,24),new google.maps.Point(0,0),new google.maps.Point(12,12));
MI_Dead=new google.maps.MarkerImage("images/dead.png",new google.maps.Size(24,24),new google.maps.Point(0,0),new google.maps.Point(12,12),new google.maps.Size(24,24));function haversineDistance(a,b){var e=(b.lat-a.lat)*Math.PI/180,d=(b.lng-a.lng)*Math.PI/180;e=Math.sin(e/2)*Math.sin(e/2)+Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(d/2)*Math.sin(d/2);return RAD_TO_METERS*2*Math.atan2(Math.sqrt(e),Math.sqrt(1-e))}
function getRank(a){return a<100?"Trainee":a<300?"Rookie":a<1E3?"Agent":"Pro"}function calcXP(a){if(!a.aliveSince)return a.gxp;return Math.floor((serverTimeDiff+(new Date).getTime()-a.aliveSince)/6E4)+a.gxp}function numReadyMissiles(a){for(var b=0,e=0;e<a.length;++e)a[e]===null&&b++;return b}function connectLoop(){if(socket.connected)reconnectBox.hide();else{setTimeout(connectLoop,2E3);socket.connect()}}
function killed(){actionToggle(null,null,false);actionButtons.setPressed(attackButton,false);actionButtons.setPressed(defenseButton,false);attackButton.disable(true);defenseButton.disable(true);worldTopbar.setTitle("<font size=-1>You died</font>");respawnButton.show()}function alive(){socket.send({e:"respawn",uid:uid})}
function drawPlayer(a,b){var e=new google.maps.LatLng(allPlayers[a].coords.lat,allPlayers[a].coords.lng),d=null;if(b)d=google.maps.Animation.DROP;allPlayers[a].marker&&allPlayers[a].marker.setMap(null);if(allPlayers[a].hp>0){allPlayers[a].marker=new google.maps.Marker({position:e,map:worldMap.map,animation:d,clickable:actionButtons.getPressed()!==attackButton,icon:MI_Soldier});a===uid&&allPlayers[a].marker.setAnimation(google.maps.Animation.BOUNCE)}else allPlayers[a].marker=new google.maps.Marker({position:e,
map:worldMap.map,clickable:actionButtons.getPressed()!==attackButton,icon:MI_Dead});allPlayers[a].marker.info=allPlayers[a];google.maps.event.addListener(allPlayers[a].marker,"click",function(){this.info.hp>0?Ext.Msg.alert(this.info.name,this.info.hp+"hp "+calcXP(this.info)+"xp"):Ext.Msg.alert(this.info.name,this.info.name+"'s remains lay here")})}
function drawMissile(a){var b=(serverTimeDiff+(new Date).getTime()-allMissiles[a].departureTime)/(allMissiles[a].arrivalTime-allMissiles[a].departureTime);if(!(b>1||b<0)){b=[new google.maps.LatLng(allMissiles[a].departureCoords.lat,allMissiles[a].departureCoords.lng),new google.maps.LatLng(allMissiles[a].departureCoords.lat+(allMissiles[a].arrivalCoords.lat-allMissiles[a].departureCoords.lat)*b,allMissiles[a].departureCoords.lng+(allMissiles[a].arrivalCoords.lng-allMissiles[a].departureCoords.lng)*
b)];if(allMissiles[a].line)allMissiles[a].line.setPath(b);else{b=new google.maps.Polyline({path:b,strokeColor:"#00FFFF",strokeOpacity:1,strokeWeight:2,clickable:false});b.setMap(worldMap.map);allMissiles[a].line=b}}}
function populateMap(){for(var a in allPlayers)drawPlayer(a);navigator.geolocation.watchPosition(function(b){if(!(yourLocation.lat===b.coords.latitude&&yourLocation.lng===b.coords.longitude)){yourLocation={lat:b.coords.latitude,lng:b.coords.longitude};if(allPlayers[uid].hp>0){allPlayers[uid].coords.lat=b.coords.latitude;allPlayers[uid].coords.lng=b.coords.longitude;socket.send({e:"move",uid:uid,loc:allPlayers[uid].coords});allPlayers[uid].marker.setPosition(new google.maps.LatLng(b.coords.latitude,
b.coords.longitude))}}})}
shieldToggle=function(a,b,e){this.shieldTimer&&clearInterval(this.shieldTimer);if(e){if(b!=="sync"){socket.send({e:"shield",uid:uid,active:1});allPlayers[uid].items.s.a=1}this.shieldTimer=setInterval(function(){if(allPlayers[uid].items.s.e>0){allPlayers[uid].items.s.e--;shieldButton.setBadge(allPlayers[uid].items.s.e)}if(allPlayers[uid].items.s.e===0){clearInterval(this.shieldTimer);this.shieldTimer=null}},1E3)}else{if(b!=="sync"){socket.send({e:"shield",uid:uid,active:0});allPlayers[uid].items.s.a=
0}this.shieldTimer=setInterval(function(){if(allPlayers[uid].items.s.e<100){allPlayers[uid].items.s.e++;shieldButton.setBadge(allPlayers[uid].items.s.e)}if(allPlayers[uid].items.s.e===100){clearInterval(this.shieldTimer);this.shieldTimer=null}},1E3)}};uid=localStorage.uid;if(!uid){uid=Math.random().toString().substring(2);localStorage.uid=uid}
socket.on("message",function(a){console.log(a);if(a.e==="sync"){serverTimeDiff=a.time-(new Date).getTime();if(allPlayers)for(var b in allPlayers)allPlayers[b].marker&&allPlayers[b].marker.setMap(null);allPlayers=a.players;if(allMissiles)for(b=0;b<allMissiles.length;++b)allMissiles[b]&&allMissiles[b].line&&allMissiles[b].line.setMap(null);shieldToggle(null,"sync",allPlayers[uid].items.s.a===1);allMissiles=a.missiles;allPlayers[uid].hp<=0&&worldTopbar&&killed();allPlayers[uid].readyMissiles=numReadyMissiles(allPlayers[uid].items.m.m);
missileButton.setBadge(allPlayers[uid].readyMissiles);allPlayers[uid].readyMissiles===0&&missileButton.disable(true);shieldButton.setBadge(allPlayers[uid].items.s.e);populateMap();setInterval(tick,TICK_INTERVAL)}else if(a.e==="player"){allPlayers[a.player._id]=a.player;drawPlayer(a.player._id,true)}else if(a.e==="missile")allMissiles.push(a.missile);else if(a.e==="moved"){b=new google.maps.LatLng(a.loc.lat,a.loc.lng);allPlayers[a.player].coords=b;allPlayers[a.player].marker&&allPlayers[a.player].marker.setPosition(b)}else if(a.e===
"damage")for(b=0;b<a.damage.length;++b){allPlayers[a.damage[b].player].hp-=a.damage[b].dmg;if(allPlayers[a.damage[b].player].hp<=0&&a.damage[b].dmg>0){allPlayers[a.damage[b].player].hp=0;allPlayers[a.damage[b].player].marker.setMap(null);allPlayers[a.damage[b].player].aliveSince=null;drawPlayer(a.damage[b].player);if(a.damage[b].player===uid&&worldTopbar){killed();Ext.Msg.alert("Dead!",allPlayers[uid].name+", you have been killed!")}}if(a.damage[b].player===uid){allPlayers[uid].items.s.e-=a.damage[b].sDmg;
shieldButton.setBadge(allPlayers[uid].items.s.e)}}else if(a.e==="gxp")allPlayers[a.uid].gxp+=a.gxp;else if(a.e==="events"){b="<b>Recent events</b>";for(var e=0;e<a.events.length;e++){var d=a.events[e],c=new Date(parseInt(d._id.substring(0,8),16)*1E3);b+="<br><font color='grey'>"+c.getMonth()+1+"/"+c.getDate()+" "+c.getHours()+":"+(c.getMinutes()<10?"0":"")+c.getMinutes()+":"+(c.getSeconds()<10?"0":"")+c.getSeconds()+"</font> ";if(d.e==="missile")b+="Launched missile <img src='images/missile.png'>";
else if(d.e==="kill")b+="Killed "+allPlayers[d.data].name+" <img src='images/dead.png'>";else if(d.e==="killed")b+="Killed by "+allPlayers[d.data].name+" <img width='16' height='16' src='images/dead.png'>";else if(d.e==="damage"){b+="You hit";for(c=0;c<d.data.length;c++){var f=d.data[c];b+=" "+allPlayers[f.player].name+" ("+f.dmg+" <img src='images/damage.png'>)"}}else if(d.e==="damaged")b+="Hit by missile (-"+d.data.dmg+" <img src='images/health.png'>, -"+d.data.sDmg+"<img src='images/shield.png'>)";
else if(d.e==="respawn")b+="Respawned <img src='images/respawn.png'>";else if(d.e==="shield")b+=d.active===1?"Activated shields":"Deactivated shields"}eventPane.update('<font color="9afe2e">'+b+"</font>")}else if(a.e==="respawn"){if(uid===a.player._id){respawnButton.hide();attackButton.enable(true);defenseButton.enable(true);worldTopbar.setTitle("");allPlayers[uid].readyMissiles=numReadyMissiles(allPlayers[uid].items.m.m);missileButton.setBadge(allPlayers[uid].readyMissiles);allPlayers[uid].readyMissiles===
0&&missileButton.disable(true);shieldButton.setBadge(allPlayers[uid].items.s.e)}allPlayers[a.player._id].marker&&allPlayers[a.player._id].marker.setMap(null);allPlayers[a.player._id]=a.player;drawPlayer(a.player._id,true)}else if(a.e==="say"){var g=new google.maps.InfoWindow({content:a.msg,disableAutoPan:true});g.open(worldMap.map,allPlayers[a.uid].marker);setTimeout(function(){g.close()},1E4)}});socket.on("connect",function(){yourLocation&&socket.send({e:"init",uid:uid,loc:yourLocation})});
socket.on("disconnect",function(){reconnectBox=Ext.Msg.show({title:"Disconnected",msg:"Attempting to automatically reconnect...",buttons:[]});setTimeout(connectLoop,2E3)});
Ext.setup({icon:"icon.png",phoneStartupScreen:"images/phone_startup.png",glossOnIcon:true,onReady:function(){Ext.Msg.enterAnimation=false;Ext.Msg.exitAnimation=false;actionToggle=function(c,f,g){if(f===attackButton&&g){worldTopbar.setTitle("<font size=-1>Tap target</font>");for(var h in allPlayers)allPlayers[h].marker&&allPlayers[h].marker.setClickable(false);targetListener=google.maps.event.addListener(worldMap.map,"click",function(i){target&&target.setMap(null);target=new google.maps.Marker({position:i.latLng,
map:worldMap.map,clickable:false,zIndex:9999,icon:MI_Crosshairs});missileButton.show();i=haversineDistance({lat:target.getPosition().lat(),lng:target.getPosition().lng()},allPlayers[uid].coords);worldTopbar.setTitle("<font size=-1>"+Math.round(i)+"m ("+Math.round((-MISSILE_VELOCITY+Math.sqrt(MISSILE_VELOCITY*MISSILE_VELOCITY+2*MISSILE_ACCELERATION*i))/MISSILE_ACCELERATION)+"s)</font>")})}else{missileButton.hide();worldTopbar.setTitle("");target&&target.setMap(null);if(targetListener){google.maps.event.removeListener(targetListener);
targetListener=null}for(h in allPlayers)allPlayers[h].marker&&allPlayers[h].marker.setClickable(true)}if(f===defenseButton&&g){defenseButtons.show();defenseButtons.setPressed(shieldButton,allPlayers[uid].items.s.a===1,true)}else defenseButtons.hide()};missileButton=new Ext.Button({text:"Missile",ui:"action",hidden:true,handler:function(){socket.send({e:"m",uid:uid,loc:{lat:target.getPosition().lat(),lng:target.getPosition().lng()}});allPlayers[uid].readyMissiles--;missileButton.setBadge(allPlayers[uid].readyMissiles);
allPlayers[uid].readyMissiles===0&&missileButton.disable(true)}});missileButton.setWidth(84);shieldButton=new Ext.Button({text:"Shield",ui:"action"});shieldButton.setWidth(94);defenseButtons=new Ext.SegmentedButton({allowDepress:true,listeners:{toggle:shieldToggle},items:[shieldButton],hidden:true});defenseButtons.setWidth(94);respawnButton=new Ext.Button({text:"Respawn",hidden:true,handler:alive,ui:"confirm"});attackButton=new Ext.Button({cls:"attackButton",ui:"action"});defenseButton=new Ext.Button({cls:"defenseButton",
ui:"action"});actionButtons=new Ext.SegmentedButton({allowDepress:true,listeners:{toggle:actionToggle},items:[attackButton,defenseButton]});var a=new Ext.Button({text:"Say",ui:"action",handler:function(){Ext.Msg.prompt("Say what?",null,function(c,f){c==="ok"&&socket.send({e:"say",uid:uid,msg:f})})}});worldTopbar=new Ext.Toolbar({dock:"top",title:"<font size=-1>GPS Missiles</font>",items:[actionButtons,a,{xtype:"spacer"},missileButton,defenseButtons,respawnButton]});allPlayers&&allPlayers[uid].hp<=
0&&killed();a=yourLocation?new google.maps.LatLng(yourLocation.lat,yourLocation.lng):new google.maps.LatLng(47.6063889,-122.3308333);worldMap=new Ext.Map({mapOptions:{center:a,zoom:13,mapTypeId:"customMap",mapTypeControl:false,streetViewControl:false,zoomControl:true},listeners:{maprender:function(c,f){f.mapTypes.set("customMap",new google.maps.StyledMapType(MapStyles.tron,{name:"Custom Style"}));socket.connect()}}});a=new Ext.Panel({iconCls:"search",title:"World",items:[worldMap],dockedItems:[worldTopbar]});
var b=new Ext.form.Text({name:"username",label:"Name"}),e=new Ext.Container;eventPane=new Ext.Container({html:"<b>Recent events</b>",style:{fontSize:"75%"}});var d=new Ext.Panel({title:"Profile",iconCls:"user",listeners:{activate:function(){b.setValue(allPlayers[uid].name);var c=calcXP(allPlayers[uid]);c="<table><tr><td><img src='images/health.png'> "+allPlayers[uid].hp+" / 100<br></td><td><img src='images/missile.png'> "+allPlayers[uid].readyMissiles+" missiles ready<br></td></tr><tr><td><img src='images/xp.png'> "+
c+"xp <font size='-1'><b>"+getRank(c)+"</b></font><br></td><td><img src='images/damage.png'> "+allPlayers[uid].items.m.d+" max damage<br></td></tr><tr><td><img src='images/attack.png'> "+allPlayers[uid].gxp/100+" kills<br></td><td><img src='images/blast.png'> "+allPlayers[uid].items.m.r+" blast radius</td></tr></table>";e.update('<font color="9afe2e">'+c+"</font>");socket.send({e:"events",uid:uid})}},items:[{xtype:"form",scroll:"vertical",baseCls:"background",items:[b,{xtype:"spacer",height:5},{xtype:"button",
text:"Save Name",ui:"confirm",width:140,handler:function(){var c=b.getValue();if(c){allPlayers[uid].name=c;socket.send({e:"name",uid:uid,name:c});this.setText("Saved");this.disable(true)}}},{xtype:"spacer",height:15},e,{xtype:"spacer",height:14},eventPane]}]});new Ext.TabPanel({fullscreen:true,cardSwitchAnimation:false,style:{backgroundColor:"black"},tabBar:{dock:"bottom",layout:{pack:"center"}},items:[a,d]});navigator.geolocation?navigator.geolocation.getCurrentPosition(function(c){yourLocation=
{lat:c.coords.latitude,lng:c.coords.longitude};if(allPlayers&&allPlayers[uid].hp>0)allPlayers[uid].coords=yourLocation;c.coords.accuracy>1E3&&Ext.Msg.alert("Geolocation Approximation","You location is currently only accurate within "+Math.round(c.coords.accuracy)+" meters.");worldMap.map.setCenter(new google.maps.LatLng(c.coords.latitude,c.coords.longitude));socket.connected&&socket.send({e:"init",uid:uid,loc:yourLocation})},function(c){Ext.Msg.alert("Geolocation error",c.message)},{enableHighAccuracy:true,
timeout:2E4}):Ext.Msg.alert("No Geolocation","Your browser does not support geolocation. Please try a different browser.")}});
tick=function(){for(var a=0;a<allMissiles.length;++a)if(allMissiles[a])if(serverTimeDiff+(new Date).getTime()>allMissiles[a].arrivalTime)if(allMissiles[a].blastR){if(allMissiles[a].blastR>=MISSILE_RADIUS&&allMissiles[a].blastR%2===0)allMissiles[a].blastR--;else if(allMissiles[a].blastR%2===0)allMissiles[a].blastR+=BLAST_SPEED;else if(allMissiles[a].blastR<BLAST_SPEED){allMissiles[a].c.setMap(null);allMissiles[a]=null;continue}else allMissiles[a].blastR-=BLAST_SPEED;allMissiles[a].c.setRadius(allMissiles[a].blastR)}else{allMissiles[a].blastR=
BLAST_SPEED;if(allMissiles[a].line){allMissiles[a].line.setMap(null);allMissiles[a].line=null}if(allMissiles[a].owner===uid){allPlayers[uid].readyMissiles++;missileButton.setBadge(allPlayers[uid].readyMissiles);missileButton.enable(true)}allMissiles[a].c=new google.maps.Circle({center:new google.maps.LatLng(allMissiles[a].arrivalCoords.lat,allMissiles[a].arrivalCoords.lng),fillColor:"#00FFFF",fillOpacity:0.5,strokeColor:"#00FFFF",map:worldMap.map,clickable:false,radius:BLAST_SPEED})}else drawMissile(a)};
